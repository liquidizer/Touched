<html>
  <meta charset="UTF-8"/>
  <link type="text/css" href="/style.css" rel="stylesheet"/>

  <!-- editor scripts -->
  <script type="text/javascript" src="/lib/jquery.min.js"></script>
  <script type="text/javascript" src="/touched.js"></script>
  <script type="text/javascript" src="/touched-types.js"></script>
  <script type="text/javascript" src="/touched-menu.js"></script>
  <script type="text/javascript" src="/touched-tocode.js"></script>

  <!-- execution scripts -->
  <script type="text/javascript" src="/lib/d3.v2.js"></script>
  <script type="text/javascript" src="/exec.js"></script>
  <script type="text/javascript" src="/exec.d3.js"></script>
  <script type="text/javascript" src="/exec.viz.js"></script>
  <script type="text/javascript" src="/exec.filter.js"></script>
  <style>
    #execution {
        position: absolute;
        top: 60;
        left: 50%;
        width: 45%;
        background: white;
    }
    #dataview table,td {
      border-collapse: collapse;
      border: 1px black solid
    }
  </style>
  <script language="javascript">
      var code= '<touched:code>';
      var file= '<touched:file>';
      var viewsplit= undefined;
      $(function() {
        initTouched('canvas','menu','<touched:g>', decodeURI('<touched:content>'), !!code);
        $('#canvas').bind('update', function() { saveContent(); runContent(); });
        $('#autoupdate').bind('change', runContent);
	$('#handle').bind('mousedown', viewDown);
	if (!code) {
	    $('#execution').append('<input type="button" id="EDIT" value="EDIT"/>');
	    $('#EDIT').click(function() { window.location= '/'+file+'?mode=edit'; });
	}
      });
      function viewDown(evt) {
        var viewsplit= $('#execution').offset().left - evt.clientX;
	evt.preventDefault();
	var viewUp= function(evt) {
	  $('body').unbind('mousemove', viewMove);
	  $('body').unbind('mouseup', viewUp);
	}
	var viewMove= function(evt) {
	  $('#execution').offset({ left : viewsplit + evt.clientX});
	}
        $('body').bind('mousemove', viewMove);
        $('body').bind('mouseup', viewUp);
      }

      function saveContent() {
          var content = $('#canvas').html();
          var http = new XMLHttpRequest();
          http.onreadystatechange = function() { 
             if (http.readyState==4 && http.status!=200) 
                 $('#menu').html('<b>Error saving document</b>');
          };
          http.open("POST", '/'+file+'?mode=save&code='+code, true);
          http.send(content);
      }
      function runContent() {
          if ($('#autoupdate').attr('checked')) {
             $('#dataview').show();
	     execute();
	  } else {
	     clearErrors();
	     $('#dataview').hide();
	  }
      }
  </script>
  <body>
    <div id="menubar">
      <ul id="menu"/>
    </div>
    <div style="height:50px">Touched Editor</div>
    <div>
      <div id="canvas"></div>
      <div style="height:50px; clear:both"/>
      <div id="execution">
	<input type='checkbox' id="autoupdate"/><span id="handle">Run</span>
	<div id="dataview"/>
      </div>
    </div>
  </body>
</html>
