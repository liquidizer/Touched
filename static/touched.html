<html>
  <head>
    <meta charset="UTF-8"/>
    <link type="text/css" href="/style.css" rel="stylesheet"/>

    <!-- editor scripts -->
    <script type="text/javascript" src="/lib/jquery.min.js"></script>
    <script type="text/javascript" src="/touched.js"></script>
    <script type="text/javascript" src="/touched-types.js"></script>
    <script type="text/javascript" src="/touched-menu.js"></script>
    <script type="text/javascript" src="/touched-tocode.js"></script>

    <!-- execution scripts -->
    <script type="text/javascript" src="/lib/d3.v2.js"></script>
    <script type="text/javascript" src="/exec.js"></script>
    <script type="text/javascript" src="/exec.d3.js"></script>
    <script type="text/javascript" src="/exec.viz.js"></script>
    <script type="text/javascript" src="/exec.filter.js"></script>
    <style>
      #execution {
      position: absolute;
      top: 60px;
      left: 500px;
      width: 45%;
      background: white;
      }
      #execControl {
      border: 1px solid black;
      border-radius: 5px;
      }
      #dataview table,td {
      border-collapse: collapse;
      border: 1px black solid
      }
    </style>
  </head>
  <script language="javascript">
      var code= '<touched:code>';
      var file= '<touched:file>';
      var viewsplit= undefined;
      $(function() {
        initTouched('canvas','menu','<touched:g>', $('#code > div')[0], !!code);
        $('#canvas').bind('update', function() { saveContent(); runContent(); });
        $('#autoupdate').bind('change', runContent);
	$('#execControl').bind('mousedown', viewDown);
	if (!code) {
	    $('#execControl').append('<input type="button" id="EDIT" value="EDIT"/>');
	    $('#EDIT').click(function() { window.location= '/'+file+'?edit'; });
	}
      });
      function viewDown(evt) {
        var viewsplit= $('#execution').offset().left - evt.clientX;
	evt.preventDefault();
	var viewUp= function(evt) {
	  $('body').unbind('mousemove', viewMove);
	  $('body').unbind('mouseup', viewUp);
	}
	var viewMove= function(evt) {
	  var left=viewsplit+evt.clientX;
	  $('#execution').offset({ left : viewsplit+evt.clientX });
	}
        $('body').bind('mousemove', viewMove);
        $('body').bind('mouseup', viewUp);
      }

      function saveContent() {
          var content = $('#canvas').html();
          var http = new XMLHttpRequest();
          http.onreadystatechange = function() { 
             if (http.readyState==4 && http.status!=200) 
                 $('#menu').html('<b>Error saving document</b>');
          };
          http.open("POST", '/'+file+'?save&code='+code, true);
          http.send(content);
      }
      function runContent() {
	  clearErrors();
          if ($('#autoupdate').attr('checked')) {     	        	    
             $('#dataview').show();
	         execute('canvas', 'dataview');
	  } else {
	     //$('#dataview').hide();
	     $('#dataview').empty(); 
	     codestring = "";
	  }
      }
  </script>
  <body>
    <div id="menubar">
      <ul id="menu"/>
    </div>
    <div style="height:50px">Touched Editor</div>
    <div>
      <div id="canvas"></div>
      <div style="height:50px; clear:both"/>
      <div id="execution">
	<div id="execControl">
	  <input type='checkbox' id="autoupdate"/>
	  <span id="handle">Run</span>
	</div>
	<div id="dataview"/>
      </div>
    </div>
  </body>
  <div id="code" style="display:none"><!--touched:content--></div>
</html>
